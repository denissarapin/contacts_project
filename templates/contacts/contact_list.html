{% extends "base.html" %}
{% load contact_extras %}
{% block title %}Contacts{% endblock %}

{% block content %}
<div class="d-flex flex-wrap gap-2 align-items-end justify-content-between mb-3">
  <form class="d-flex gap-2" method="get" action="/">
    <div>
      <label class="form-label mb-1">Search</label>
      <input class="form-control" name="q" value="{{ search_query }}" placeholder="Name, email, phone, city">
    </div>
    <div>
      <label class="form-label mb-1">Sort</label>
      <select class="form-select" name="sort">
        <option value="last_name" {% if sort_key == "last_name" %}selected{% endif %}>Last name</option>
        <option value="created_at" {% if sort_key == "created_at" %}selected{% endif %}>Created date</option>
      </select>
    </div>
    <div class="align-self-end">
      <button class="btn btn-primary">Apply</button>
    </div>
  </form>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>City</th>
        <th>Status</th>
        <th>Created</th>
        <th>Weather</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for contact in contacts %}
        <tr>
          <td>{{ contact.first_name }} {{ contact.last_name }}</td>
          <td>{{ contact.phone_number }}</td>
          <td>{{ contact.email }}</td>
          <td>{{ contact.city }}</td>
          <td>{{ contact.status.name }}</td>
          <td>{{ contact.created_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% with weather=weather_by_city|get_item:contact.city %}
              {% if weather %}
                <div class="small">
                  <div>Temp: {{ weather.temperature }}Â°C</div>
                  <div>Humidity: {{ weather.humidity }}%</div>
                  <div>Wind: {{ weather.windspeed }} km/h</div>
                </div>
              {% else %}
                <span class="text-muted small">No data</span>
              {% endif %}
            {% endwith %}
          </td>
          <td class="text-end">
            <div class="d-none d-xxl-inline-block">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'contacts:contact_update' contact.id %}">Edit</a>
              <form class="d-inline" method="post" action="{% url 'contacts:contact_delete' contact.id %}">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
              </form>
            </div>
            <div class="dropdown d-xxl-none">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                  <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="{% url 'contacts:contact_update' contact.id %}">Edit</a>
                </li>
                <li>
                  <form method="post" action="{% url 'contacts:contact_delete' contact.id %}" class="mb-0">
                    {% csrf_token %}
                    <button class="dropdown-item text-danger" type="submit" onclick="return confirm('Are you sure you want to delete this contact?');">Delete</button>
                  </form>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">No contacts</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
